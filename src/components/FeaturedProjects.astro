---
import { Card, Heading, Link } from 'accessible-astro-components'
import { Icon } from 'astro-icon/components'
import { getCollection } from 'astro:content'

// Import images directly for optimization
import projectImage1 from '@assets/images/projects/project-image-1.png'
import projectImage2 from '@assets/images/projects/project-image-2.png'
import projectImage3 from '@assets/images/projects/project-image-3.png'
import projectImage4 from '@assets/images/projects/project-image-4.png'
import projectImage5 from '@assets/images/projects/project-image-5.png'
import projectImage6 from '@assets/images/projects/project-image-6.png'

/**
 * FeaturedProjects Component
 *
 * @description A component that displays featured projects from Astro Content Collections
 */
interface Props {
  /**
   * Additional classes to apply to the section
   */
  class?: string
  /**
   * The number of projects to display
   * @default 3
   */
  limit?: number
  /**
   * The title for the section
   * @default "Featured projects"
   */
  title?: string
}

const { class: className, limit = 3, title = 'Featured projects' } = Astro.props

// Get projects from content collection
const projects = await getCollection('projects')

// Sort projects by order field (ascending), projects without order go last
const sortedProjects = [...projects].sort((a, b) => {
  const orderA = a.data.order ?? Number.MAX_SAFE_INTEGER
  const orderB = b.data.order ?? Number.MAX_SAFE_INTEGER
  return orderA - orderB
})

const projectImages = [projectImage1, projectImage2, projectImage3, projectImage4, projectImage5, projectImage6]

// Limit projects and add featured images with the same logic as portfolio page
const featuredProjects = sortedProjects.slice(0, limit).map((project, index) => {
  // Check if project has a custom featuredImage from frontmatter
  const customImage = project.data.featuredImage
  
  if (customImage?.src) {
    // Use custom image path from frontmatter
    return {
      ...project,
      featuredImage: undefined, // Don't use imageComponent
      featuredImagePath: customImage.src, // Use img prop instead
      featuredImageAlt: customImage.alt || project.data.title,
    }
  } else {
    // Use fallback imported image component
    return {
      ...project,
      featuredImage: projectImages[index % projectImages.length],
      featuredImagePath: undefined,
      featuredImageAlt: undefined,
    }
  }
})
---

<section class:list={[className, 'my-24']}>
  <div class="container">
    <Heading level="h2" class="mb-6">{title}</Heading>
    <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
      {
        featuredProjects.map((project) => (
          <Card
            imageComponent={project.featuredImage}
            img={project.featuredImagePath}
            imageAlt={project.featuredImageAlt || project.data.title}
            url={'/portfolio/' + project.id}
            headingLevel="h2"
            title={project.data.title}
            footer={project.data.company ? `Company: ${project.data.company}` : undefined}
          >
            {project.data.description}
            {project.data.minutes && (
              <span slot="meta">
                <Icon name="lucide:clock" />
                {project.data.minutes} min read
              </span>
            )}
          </Card>
        ))
      }
    </div>
    <div class="mt-12">
      <Link href="/portfolio/" isButton animateOnHover animationType="nudge">
        View all projects
        <Icon aria-hidden="true" name="lucide:arrow-right" size="1.5rem" />
      </Link>
    </div>
  </div>
</section>
