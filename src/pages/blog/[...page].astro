---
import DefaultLayout from '@layouts/DefaultLayout.astro'
import PageHeader from '@components/PageHeader.astro'
import { Card, Pagination, Link } from 'accessible-astro-components'
import type { PaginateFunction, Page } from 'astro'
import { getSubstackPosts, formatPubDate, SUBSTACK_HOME_URL, type SubstackPost } from '@lib/substack'

export async function getStaticPaths({ paginate }: { paginate: PaginateFunction }) {
  const posts = await getSubstackPosts()
  return paginate(posts, { pageSize: 6 })
}

interface Props {
  page: Page<SubstackPost>
}

const { page } = Astro.props as Props
---

<DefaultLayout
  title="Writing"
  description="Essays and updates from my newsletter on Substack."
>
  <PageHeader
    title="Writing"
    subtitle="Essays and updates from my newsletter, hosted on Substack."
    bgType="bordered"
  />

  <section class="my-12">
    <div class="container">
      {page.data.length === 0 ? (
        <p class="text-lg">
          No posts yet. <a href={SUBSTACK_HOME_URL} target="_blank" rel="noopener noreferrer">Check out my Substack</a> to subscribe.
        </p>
      ) : (
        <>
          <p class="text-sm"><em>Post {page.start + 1} through {page.end + 1} of {page.total} total posts</em></p>
          <ul class="my-3 grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
            {
              page.data.map((post) => (
                <li>
                  <Card
                    url={post.link}
                    title={post.title}
                    headingLevel="h2"
                    footer={formatPubDate(post.pubDate)}
                    fullHeight={true}
                  >
                    {post.contentSnippet || 'Read more on Substack.'}
                  </Card>
                </li>
              ))
            }
          </ul>
          {page.lastPage > 1 && (
            <div class="mt-12 grid place-content-center">
              <Pagination
                firstPage={page.url.prev ? '/blog' : null}
                previousPage={page.url.prev ? page.url.prev : null}
                nextPage={page.url.next ? page.url.next : null}
                lastPage={page.url.next ? `/blog/${page.lastPage}` : null}
                currentPage={`${page.currentPage}`}
                totalPages={`${page.lastPage}`}
                ariaLabel="Writing pagination"
              />
            </div>
          )}
        </>
      )}
      <p class="mt-8">
        <Link href={SUBSTACK_HOME_URL} isButton target="_blank" rel="noopener noreferrer">
          Subscribe on Substack
        </Link>
      </p>
    </div>
  </section>
</DefaultLayout>
